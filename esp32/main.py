import network

from umqtt.simple import MQTTClient

from button import PushButton
from irsend import IrSender


def connect_network():
    '''Connect to WiFi and disable AP'''
    sta_if = network.WLAN(network.STA_IF)
    if not sta_if.isconnected():
        print('Connecting to network...')
        sta_if.active(True)
        sta_if.connect('***REMOVED***', '***REMOVED***')
        while not sta_if.isconnected():
            pass

    config = sta_if.ifconfig()

    print('network config:', config)

    return config


def main():
    # Key codes gotten from AnalysIR
    keys = \
        {
            'tv': {
                'red': [2581, -917, 405, -875, 427, -448, 405, -469, 384, -917, 832, -469, 405, -469, 405, -448, 384, -469, 384, -469, 384, -469, 405, -469, 405, -469, 384, -469, 832, -469, 384, -896, 853, -469, 384, -896, 853, -84309, 2581, -917, 405, -896, 405, -469, 363, -512, 341, -917, 832, -512, 341, -512, 341, -512, 341, -512, 341, -512, 341, -512, 341, -512, 341, -512, 341, -491, 811, -512, 341, -917, 853, -491, 341, -917, 853]
            },
            'ac': {
                'on': [9120, -4592, 555, -1745, 555, -1745, 555, -555, 555, -555, 555, -555, 555, -555, 555, -555, 555, -1745, 555, -555, 555, -1745, 555, -1745, 555, -555, 555, -555, 555, -555, 555, -555, 555, -555, 555, -555, 555, -555, 555, -1745, 555, -555, 555, -555, 555, -555, 555, -555, 555, -555, 555, -555, 555, -1745, 555, -555, 555, -555, 555, -555, 555, -1745, 555, -1745, 555, -555, 555, -555, 555, -555, 555, -555, 555, -555, 555, -555, 555, -555, 555, -555, 555, -555, 555, -555, 555, -555, 555, -555, 555, -555, 555, -555, 555, -555, 555, -555, 555, -555, 555, -8085, 555, -1745, 555, -555, 555, -555, 555, -555, 555, -555, 555, -555, 555, -555, 555, -1745, 555, -555, 555, -555, 555, -1745, 555, -555, 555, -1745, 555, -1745, 555, -555, 555, -555, 555, -555, 555, -555, 555, -555, 555, -555, 555, -555, 555, -555, 555, -555, 555, -555, 555, -555, 555, -555, 555, -555, 555, -555, 555, -555, 555, -555, 555, -555, 555, -555, 555, -555, 555, -555, 555, -555, 555, -555, 555, -555, 555, -555, 555, -555, 555, -555, 555, -555, 555, -555, 555, -555, 555, -555, 555, -555, 555, -555, 555, -555, 555, -555, 555, -555, 555, -555, 555, -555, 555, -555, 555, -555, 555, -555, 555, -555, 555, -555, 555, -1745, 555, -1745, 555, -555, 555, -555, 555, -1745, 555, -555, 555, -1745, 555, -1745, 555, -8064, 555, -555, 555, -555, 555, -555, 555, -555, 555, -555, 555, -555, 555, -555, 555, -555, 555, -1745, 555, -555, 555, -555, 555, -555, 555, -555, 555, -555, 555, -555, 555, -555, 555, -555, 555, -555, 555, -555, 555, -555, 555, -555, 555, -555, 555, -555, 555, -555, 555, -555, 555, -555, 555, -555, 555, -555, 555, -555, 555, -555, 555, -555, 555, -555, 555, -555, 555, -555, 555, -555, 555, -555, 555, -555, 555, -555, 555, -555, 555, -555, 555, -555, 555, -555, 555, -555, 555, -555, 555, -555, 555, -555, 555, -555, 555, -555, 555, -1745, 555, -555, 555, -555, 555, -555, 555, -555, 555, -555, 555, -555, 555, -555, 555]
            }
        }

    irsender = IrSender()

    def single_press_action(): return irsender.send(keys['tv']['red'])

    def long_press_action(): return irsender.send(keys['ac']['on'])

    def double_press_action(): return print('double')

    button = PushButton(single_press_action,
                        long_press_action, double_press_action)

    connect_network()

    def mqttt_callback(topic, msg): return irsender.send(
        keys['ac']['on']) if (topic == b'ac' and msg == b'on_off') else -1

    client = MQTTClient('esp32_ir', '***REMOVED***')
    client.set_callback(mqttt_callback)
    client.connect()
    client.subscribe(b'ac')

    while True:
        client.check_msg()
        
        button.loop()

    client.disconnect()

if __name__ == '__main__':
    main()
